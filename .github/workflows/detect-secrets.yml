name: Detect Secrets

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    name: Secret Scanning with detect-secrets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install detect-secrets
        run: |
          pip install detect-secrets==1.5.0

      - name: Run detect-secrets scan
        run: |
          # Create a new baseline from the current codebase
          detect-secrets scan --baseline .secrets.baseline.new

          # If baseline exists, compare against it
          if [ -f .secrets.baseline ]; then
            echo "üìã Comparing against existing baseline..."
            detect-secrets audit .secrets.baseline --report --json > current.json || true
            detect-secrets audit .secrets.baseline.new --report --json > new.json || true

            # Check if new secrets were added
            CURRENT_COUNT=$(cat current.json | jq '.results | length')
            NEW_COUNT=$(cat new.json | jq '.results | length')

            echo "Current baseline: $CURRENT_COUNT potential secrets"
            echo "New scan: $NEW_COUNT potential secrets"

            if [ "$NEW_COUNT" -gt "$CURRENT_COUNT" ]; then
              echo "‚ùå ERROR: New secrets detected!"
              echo "Run 'detect-secrets audit .secrets.baseline' to review and update baseline"
              detect-secrets audit .secrets.baseline.new --report
              exit 1
            else
              echo "‚úÖ No new secrets detected"
            fi
          else
            echo "‚ö†Ô∏è No baseline found, creating initial baseline..."
            mv .secrets.baseline.new .secrets.baseline
            detect-secrets audit .secrets.baseline --report
          fi

      - name: Scan new commits only
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Scanning changes in this PR..."

          # Get list of changed files in PR
          git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt

          # Scan only changed files
          if [ -s changed_files.txt ]; then
            cat changed_files.txt | xargs -I {} detect-secrets scan {} --baseline .secrets.pr.baseline || true

            # Report if secrets found in PR changes
            if [ -f .secrets.pr.baseline ]; then
              PR_SECRETS=$(cat .secrets.pr.baseline | jq '.results | length')
              if [ "$PR_SECRETS" -gt 0 ]; then
                echo "‚ö†Ô∏è WARNING: $PR_SECRETS potential secrets in PR changes"
                detect-secrets audit .secrets.pr.baseline --report
              fi
            fi
          fi

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-results
          path: |
            .secrets.baseline*
            *.json
          retention-days: 30
